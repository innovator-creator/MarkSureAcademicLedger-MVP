/**
 * Auto-detect backend port by checking common ports
 * This script tries to find the running backend server
 */

const http = require('http');
const fs = require('fs');
const path = require('path');

const COMMON_PORTS = [5000, 5001, 5002, 5003, 5004, 3001, 8000, 8080];

async function checkPort(port) {
  return new Promise((resolve) => {
    const req = http.get(`http://localhost:${port}/health`, { timeout: 1000 }, (res) => {
      let data = '';
      res.on('data', (chunk) => { data += chunk; });
      res.on('end', () => {
        try {
          const json = JSON.parse(data);
          if (json.status === 'ok' || json.message) {
            resolve(port);
          } else {
            resolve(null);
          }
        } catch {
          resolve(null);
        }
      });
    });

    req.on('error', () => resolve(null));
    req.on('timeout', () => {
      req.destroy();
      resolve(null);
    });
  });
}

async function detectBackendPort() {
  console.log('üîç Detecting backend port...');
  
  // Try common ports in parallel
  const checks = COMMON_PORTS.map(port => checkPort(port));
  const results = await Promise.all(checks);
  
  const foundPort = results.find(port => port !== null);
  
  if (foundPort) {
    console.log(`‚úÖ Backend detected on port ${foundPort}`);
    return foundPort;
  }
  
  // Default to 5000 if not found
  console.log('‚ö†Ô∏è  Backend not detected, defaulting to port 5000');
  return 5000;
}

async function updateEnvFile(port) {
  const envPath = path.join(__dirname, '..', '.env.local');
  const envContent = `# Auto-generated by detect-backend-port.js
# Backend API URL - automatically detected
NEXT_PUBLIC_API_URL=http://localhost:${port}
`;

  fs.writeFileSync(envPath, envContent, 'utf8');
  console.log(`üìù Updated .env.local with port ${port}`);
}

async function main() {
  try {
    const port = await detectBackendPort();
    await updateEnvFile(port);
    console.log('‚úÖ Configuration updated successfully');
    process.exit(0);
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    // Still write default port
    await updateEnvFile(5000);
    process.exit(1);
  }
}

if (require.main === module) {
  main();
}

module.exports = { detectBackendPort, updateEnvFile };

